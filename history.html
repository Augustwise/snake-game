<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SNAKE — History</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body class="page--history">
    <header class="page-header">SNAKE — History</header>

    <div class="history__actions">
      <a class="btn btn--accent" href="./index.html">Back to Game</a>
      <button
        class="btn btn--danger"
        id="clearHistory"
        title="Delete all stored games"
      >
        Clear
      </button>
    </div>

    <section class="history">
      <div id="empty" class="history__empty">Not played yet</div>
      <table id="historyTable" class="history__table hidden">
        <thead class="history__head">
          <tr>
            <th>Date and time</th>
            <th>Duration</th>
            <th>XP</th>
          </tr>
        </thead>
        <tbody id="history-body" class="history__body"></tbody>
      </table>
    </section>

    <script>
      function formatDuration(ms) {
        if (!ms || ms < 0) return "0s";
        let totalSeconds = Math.floor(ms / 1000);
        let hours = Math.floor(totalSeconds / 3600);
        let minutes = Math.floor((totalSeconds % 3600) / 60);
        let seconds = totalSeconds % 60;
        if (hours > 0) {
          return (
            String(hours) +
            ":" +
            String(minutes).padStart(2, "0") +
            ":" +
            String(seconds).padStart(2, "0")
          );
        }
        return (
          String(minutes).padStart(1, "0") +
          ":" +
          String(seconds).padStart(2, "0")
        );
      }

      function formatTimeOfDay(dateLike) {
        let d = new Date(dateLike);
        if (isNaN(d.getTime())) return "";

        let day = String(d.getDate()).padStart(2, "0");
        let month = String(d.getMonth() + 1).padStart(2, "0");
        let year = d.getFullYear();

        let h = String(d.getHours()).padStart(2, "0");
        let m = String(d.getMinutes()).padStart(2, "0");
        let s = String(d.getSeconds()).padStart(2, "0");

        return day + "." + month + "." + year + " " + h + ":" + m + ":" + s;
      }

      function renderHistory() {
        let data;
        try {
          data = JSON.parse(localStorage.getItem("snakeHistory") || "[]");
        } catch (e) {
          data = [];
        }
        let empty = document.getElementById("empty");
        let table = document.getElementById("historyTable");
        let tbody = document.getElementById("history-body");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          empty.classList.remove("hidden");
          table.classList.add("hidden");
          return;
        }

        data.sort(function (a, b) {
          return (
            new Date(b.playedAt).getTime() - new Date(a.playedAt).getTime()
          );
        });

        empty.classList.add("hidden");
        table.classList.remove("hidden");

        for (let i = 0; i < data.length; i++) {
          let entry = data[i];
          let tr = document.createElement("tr");

          let tdStart = document.createElement("td");
          tdStart.textContent = formatTimeOfDay(entry.playedAt);
          tr.appendChild(tdStart);

          let tdTime = document.createElement("td");
          tdTime.textContent = formatDuration(entry.durationMs);
          tr.appendChild(tdTime);

          let tdScore = document.createElement("td");
          tdScore.textContent = String(entry.score) + " XP";
          tr.appendChild(tdScore);

          tbody.appendChild(tr);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        renderHistory();
        let clearBtn = document.getElementById("clearHistory");
        clearBtn.addEventListener("click", function () {
          localStorage.removeItem("snakeHistory");
          renderHistory();
        });
      });
    </script>
  </body>
</html>
